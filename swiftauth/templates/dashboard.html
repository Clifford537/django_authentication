{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- Title with Icon -->
    <title>{% block title %}Secured Swift Pay dashboard{% endblock %}</title>
    <link rel="icon" href="{% static 'img/swift.png' %}" type="image/png">

    <!-- SEO Meta Tags -->
    <meta name="description" content="Global secure payments, fast transfers, anti-fraud technology.">

    <!-- Open Graph (for Facebook, LinkedIn, etc.) -->
    <meta property="og:title" content="Secured Swift Pay">
    <meta property="og:description" content="Global secure payments, fast transfers, anti-fraud technology.">
    <meta property="og:type" content="website">
    <meta property="og:url" content="{{ request.build_absolute_uri }}">
    <meta property="og:image" content="{% static 'img/swift.png' %}">

    <!-- Twitter Card -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="Secured Swift Pay">
    <meta name="twitter:description" content="Global secure payments, fast transfers, anti-fraud technology.">
    <meta name="twitter:image" content="{% static 'img/swift.png' %}">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css">
    <link rel="stylesheet" href="{% static 'css/styles.css' %}">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <!-- FontAwesome CDN -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">

    <style>
        
.spinner-overlay {
    position: fixed;
    width: 100%;
    height: 100%;
    background: rgba(255, 255, 255, 0.9);
    top: 0;
    left: 0;
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 9999;
}

.spinner {
    width: 100px;
    height: 100px;
    border: 10px solid white;
    border-top: 10px solid #003366;
    border-bottom: 10px solid #003366;
    border-radius: 50%;
    animation: spin 1s linear infinite;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

.d-none {
    display: none;
}
.logo-img {
    height: 30px;
    width: 40px;
    border-radius: 50%;
    object-fit: cover;
    margin-right: 8px;
    vertical-align: middle;
}

    </style>
</head>
<body>

    <!-- Full-Page Loading Spinner -->
<div id="loading-screen" class="spinner-overlay d-none">
    <div class="spinner"></div>
</div>

    <header id="header">
        <nav id="nav-bar">
            <div class="nav-left">
                <button class="menu-toggle" id="menu-toggle">&#9776;</button>
                <a href="{% url 'login' %}" class="brand">
                    <img src="{% static 'img/swift.png' %}" alt="Logo" class="logo-img">
                    Secured Swift Pay
                </a>
            </div>
            <ul id="nav-menu">
                <button class="close-menu" id="close-menu">&times;</button>
                <li><a href="{% url 'privacy_policy' %}" class="show-spinner">Privacy</a></li>
                <li><a href="{% url 'about_us' %}" class="show-spinner">About Us</a></li>
                <li><a href="{% url 'faq' %}" class="show-spinner">FAQ</a></li>
                <li><a href="{% url 'terms' %}" class="show-spinner">Terms & Conditions</a></li>
                <li><a href="{% url 'articles' %}" class="show-spinner">Articles</a></li>
                <li class="menu-year d-lg-none">Â© 2009-2025 Secured Swift Pay</li>
            </ul>            
        </nav>
    </header>
    <div>
    <div class="container mt-5">
        <!-- Header Section -->
        <div class="d-flex justify-content-between align-items-center">
            <h2>Welcome, {{ user.first_name }}</h2>
            <div class="d-flex align-items-center">
                <!-- Notifications Button -->

                <button class="btn icon-btn me-3 position-relative" data-bs-toggle="modal" data-bs-target="#notificationsModal">
                    <i class="bi bi-bell text-warning"></i>
                    <span class="badge bg-danger position-absolute top-0 start-100 translate-middle">
                        {{ unread_notifications_count|default:0 }}
                    </span>
                </button>
                
                
        
                <!-- Settings Button -->
                <a href="{% url 'account_settings' %}" class="btn icon-btn me-3 show-spinner">
                    <i class="bi bi-gear text-primary"></i>
                </a>
                
                
        
                <!-- Logout Button as Icon -->
                <a href="{% url 'logout' %}" class="btn icon-btn">
                    <i class="bi bi-box-arrow-right text-danger"></i>
                </a>
            </div>
        </div>
            {% if messages %}
            {% for message in messages %}
                <div class="alert alert-{{ message.tags }}">
                    {{ message }}
                </div>
            {% endfor %}
        {% endif %}
        

        <!-- Balance Section -->
        <div class="text-center mt-3">
            <h3>
                Balance: $<span id="balance-amount">{{ account.balance }}</span>
                <button class="btn icon-btn" id="toggle-balance">
                    <i class="bi bi-eye-slash text-dark"></i>
                </button>
            </h3>
        </div>

        <!-- Withdraw & Transfer Buttons -->
        <div class="text-center mt-3">
            <a href="{% url 'withdraw' %}" class="btn btn-primary">Withdraw</a>
            <a href="{% url 'transfer' %}" class="btn btn-primary">Send Money</a>
        </div>

 <!-- Notifications & Transactions Modal -->
<div class="modal fade" id="notificationsModal" tabindex="-1" aria-labelledby="notificationsModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="notificationsModalLabel">Notifications & Transactions</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                
                <!-- Success Messages -->
                {% if messages %}
                    {% for message in messages %}
                        <div class="alert alert-success alert-dismissible fade show" role="alert">
                            {{ message }}
                            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                        </div>
                    {% endfor %}
                {% endif %}
                
                <!-- Notifications Section -->
                <h6>Notifications</h6>
                <ul class="list-group mb-3">
                    {% for notification in notifications %}
                        <li class="list-group-item d-flex justify-content-between align-items-center {% if not notification.is_read %}fw-bold{% endif %}">
                            <div>
                                <i class="fa fa-bell text-warning"></i> 
                                {{ notification.message }}
                                <br><small class="text-muted">{{ notification.timestamp }}</small>
                            </div>
                            <div>
                                <!-- Mark as Read Button -->
                                <form action="{% url 'mark_as_read' notification.id %}" method="POST" class="d-inline">
                                    {% csrf_token %}
                                    <button type="submit" class="btn btn-sm btn-outline-primary">
                                        <i class="fa fa-check"></i>
                                    </button>
                                </form>
                                <!-- Delete Button -->
                                <form action="{% url 'delete_notification' notification.id %}" method="POST" class="d-inline">
                                    {% csrf_token %}
                                    <button type="submit" class="btn btn-sm btn-outline-danger">
                                        <i class="fa fa-trash"></i>
                                    </button>
                                </form>
                            </div>
                        </li>
                    {% empty %}
                        <li class="list-group-item text-muted">No new notifications.</li>
                    {% endfor %}
                </ul>

                <!-- Transactions Section -->
                <h6>Recent Transactions</h6>
                <ul class="list-group">
                    {% for transaction in transactions %}
                        <li class="list-group-item">
                            {% if transaction.sender %}
                                <i class="fa fa-money-bill text-success"></i>
                                {{ transaction.transaction_type|title }}: ${{ transaction.amount }} 
                                (Received from {{ transaction.sender.email }})
                            {% else %}
                                <i class="fa fa-money-bill text-success"></i>
                                {{ transaction.transaction_type|title }}: ${{ transaction.amount }} 
                                (Received from {{ transaction.source|default:"Unknown Source" }})
                            {% endif %}
                            <br>
                            <small class="text-muted">{{ transaction.timestamp }}</small>
                        </li>
                    {% empty %}
                        <li class="list-group-item text-muted">No transactions found.</li>
                    {% endfor %}
                </ul>
            </div>
        </div>
    </div>
</div>

        <!-- Saved Payment Methods -->
        <h4 class="mt-4">Saved Payment Methods</h4>
        <div class="row">
            {% if account.credit_card_number %}
            <div class="col-md-6">
                <div class="card p-3 mb-3">
                    <strong>**** **** **** {{ account.credit_card_number|slice:"-4:" }}</strong>
                    <p>Exp: {{ account.credit_card_expiry }}</p>
                    <form method="POST" action="{% url 'delete_credit_card' %}">
                        {% csrf_token %}
                        <!-- <button type="submit" class="btn btn-danger btn-sm">Remove</button> -->
                    </form>
                </div>
            </div>
            {% else %}
            <p class="text-muted">No credit card added.</p>
            {% endif %}

            {% if account.account_number %}
            <div class="col-md-6">
                <div class="card p-3 mb-3">
                    <strong>{{ account.bank_name }}</strong>
                    <p>Acc: ****{{ account.account_number|slice:"-4:" }}</p>
                    <form method="POST" action="{% url 'delete_bank_account' %}">
                        {% csrf_token %}
                        <button type="submit" class="btn btn-danger btn-sm">Remove</button>
                    </form>
                </div>
            </div>
            {% else %}
            <p class="text-muted">No bank account added.</p>
            {% endif %}
        </div>

        <!-- Add Payment Method -->
        <h4 class="mt-4">Add Payment Method</h4>
        <form method="POST" action="{% url 'add_payment_method' %}">
            {% csrf_token %}
            <div class="row">
                <div class="col-md-6">
                    <h5>Add Card</h5>
                    <input type="text" name="credit_card_number" class="form-control mb-2" placeholder="Card Number" required>
                    <input type="text" name="credit_card_cvv" class="form-control mb-2" placeholder="CVV" required>
                    <input type="month" name="credit_card_expiry" class="form-control mb-2" required>
                </div>
                <div class="col-md-6">
                    <h5>Add Bank Account</h5>
                    <input type="text" name="bank_name" class="form-control mb-2" placeholder="Bank Name" required>
                    <input type="text" name="account_number" class="form-control mb-2" placeholder="Account Number" required>
                    <input type="text" name="routing_number" class="form-control mb-2" placeholder="Routing Number" required>
                </div>
            </div>
            <button type="submit" class="btn btn-primary mt-3">Save Payment Method</button>
        </form>

<!-- Transaction History -->
<h4 class="mt-4">Transaction History</h4>
<div class="list-group">
    {% for transaction in transactions %}
    <div class="list-group-item d-flex justify-content-between align-items-center">
        <div>
            <strong>{{ transaction.timestamp|date:"Y-m-d H:i" }}</strong> <!-- Show Date & Time -->
            <span class="{% if transaction.sender == user %}text-danger{% else %}text-success{% endif %}">
                {% if transaction.sender == user %}
                    -${{ transaction.amount }}  <!-- Money Sent (Negative) -->
                {% else %}
                    +${{ transaction.amount }}  <!-- Money Received (Positive) -->
                {% endif %}
            </span>
        </div>
        <div class="text-muted">
            {% if transaction.transaction_type == 'transfer' %}
                {% if transaction.sender == user %}
                    Sent to {{ transaction.recipient.email|default:"Unknown Recipient" }}
                {% else %}
                    Received from {{ transaction.sender.email|default:"Unknown Sender" }}
                {% endif %}
            {% elif transaction.transaction_type == 'deposit' %}
                Received from {{ transaction.source|default:"External Source" }}
            {% elif transaction.transaction_type == 'withdraw' %}
                Withdrawn
            {% endif %}
        </div>
    </div>
    {% empty %}
    <p class="text-center text-muted">No transactions found.</p>
    {% endfor %}
</div>

    <br> <br>
        <footer id="footer">
            <p>Licensed by Global Monetary Exchange And America Anti-Illegal Money Transfer & Co</p>
            <p>Registration number MFN58591H46891</p>
            <p>Â© 2009-2025 Secured Swift Pay</p>
        </footer>
    
    <script>
            let isNavigationTriggered = false; // Track if a button click or link navigation was triggered
        
            document.addEventListener("DOMContentLoaded", function () {
                // Show spinner on refresh only if no button was clicked
                if (!isNavigationTriggered) {
                    document.getElementById("loading-screen").classList.remove("d-none");
        
                    // Hide spinner as soon as the page fully loads
                    window.onload = function () {
                        document.getElementById("loading-screen").classList.add("d-none");
                    };
                }
            });
        
            function showLoading(event, url = null) {
                event.preventDefault(); // Stop default action
        
                // If already navigating, prevent multiple spinners
                if (isNavigationTriggered) return;
        
                isNavigationTriggered = true; // Mark navigation as triggered
                document.getElementById("loading-screen").classList.remove("d-none"); // Show spinner
        
                // Delay only for button clicks (1.3s)
                setTimeout(function () {
                    if (url) {
                        window.location.href = url;
                    } else {
                        event.target.submit();
                    }
                }, 1300); // 1.3s delay for buttons/forms
            }
        
            // Attach spinner behavior to links and buttons
            document.addEventListener("DOMContentLoaded", function () {
                document.querySelectorAll(".show-spinner").forEach(element => {
                    element.addEventListener("click", function (event) {
                        showLoading(event, this.href);
                    });
                });
        
                document.querySelectorAll("form").forEach(form => {
                    form.addEventListener("submit", showLoading);
                });
            });
        
            // Hide spinner instantly if navigating back from cache
            window.addEventListener("pageshow", function (event) {
                if (event.persisted) { 
                    document.getElementById("loading-screen").classList.add("d-none");
                    isNavigationTriggered = false; // Reset tracking
                }
            });
        
            // Mobile Menu Toggle
            document.getElementById("menu-toggle").addEventListener("click", function () {
                document.getElementById("nav-menu").classList.add("active");
            });
        
            document.getElementById("close-menu").addEventListener("click", function () {
                document.getElementById("nav-menu").classList.remove("active");
            });

          // TOGGLE
        $(document).ready(function () {
            // Toggle Balance Visibility
            $("#toggle-balance").click(function () {
                let balance = $("#balance-amount");
                let icon = $(this).find("i");

                if (balance.is(":visible")) {
                    balance.hide();
                    icon.removeClass("bi-eye-slash").addClass("bi-eye");
                } else {
                    balance.show();
                    icon.removeClass("bi-eye").addClass("bi-eye-slash");
                }
            });
        });
  
        // Toggle Mobile Menu
        document.addEventListener("DOMContentLoaded", function () {
            const menuToggle = document.getElementById("menu-toggle");
            const navMenu = document.getElementById("nav-menu");
            const closeMenu = document.getElementById("close-menu");

            menuToggle.addEventListener("click", function () {
                navMenu.classList.add("active");
            });

            closeMenu.addEventListener("click", function () {
                navMenu.classList.remove("active");
            });
        });
    </script>

    <!-- Scripts should be at the bottom for better performance -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    
</body>
</html>
